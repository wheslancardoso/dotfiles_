import{a as K}from"./OTE5SEU6.js";import{a as R,ga as re}from"./36BQJYSV.js";import"./EF5GRFCD.js";import{V as Pe}from"./I2XYMP7X.js";import"./VV54QQJA.js";import{j as Ce}from"./WZUFDNVB.js";import{b as ne}from"./5T4V74FX.js";import{a as ee}from"./KSWBD2TZ.js";import"./RF7QDMRO.js";import"./ABULMT32.js";import{d as te}from"./MKFZQTYG.js";import{e as oe}from"./4SC7XEKB.js";import{a as L,r as F}from"./23DIE7BK.js";import"./ON4Q5ESC.js";import"./REMB6LXX.js";import{X as Z,a as N,f as Ie,l as j,y as Y}from"./BK6QTIUI.js";import{O as M,ba as se}from"./VYGUKUEK.js";import"./X6PP3PBE.js";import{a as we}from"./JS22TWPO.js";import{K as O,h as X,s as Q,w as B}from"./BR2YNKDZ.js";import{a as z}from"./BIAB2ZEP.js";import{e as S}from"./O5NYTI7P.js";var n=S(z()),G=S(we());var de=S(Ce());var me=S(Pe());var H=S(Ie());var b=S(z());var Ae=()=>{let t=document.querySelectorAll("button");return Array.from(t).some(e=>e.textContent==="Log in")},be=()=>{let t=(0,b.useRef)(null),r=(0,b.useCallback)(j(()=>{Ae()&&new M({runtime:"daemon_process"}).postMessage({event:"OpenAIDaemonProcess_daemonProcessSessionExpired",data:{}})},1e3),[]),e=(0,b.useCallback)(s=>{if(!s.every(o=>o.addedNodes.length<=0))try{r()}catch(o){}},[r]);(0,b.useEffect)(()=>{t.current=new MutationObserver(e)},[e]),(0,b.useEffect)(()=>{let s=document.querySelector("body");return t.current&&s&&t.current.observe(s,{childList:!0,subtree:!0}),()=>{t.current&&t.current.disconnect()}},[])},ae=be;var k="MAX_AI_CHAT_GPT_MESSAGE_KEY",ve=()=>document.querySelector('input[type="file"]'),ie=()=>new Promise(t=>{let r=!1,e=!1,s=3*1e3,o=setTimeout(()=>{e||(e=!0,window.removeEventListener("message",g),t(r))},s),m=N();window.postMessage({event:k,type:"ping",data:{taskId:m}});let g=c=>{var u,h,d,a,w,p;if(((u=c.data)==null?void 0:u.event)===k&&((h=c.data)==null?void 0:h.type)==="pong"&&((a=(d=c.data)==null?void 0:d.data)==null?void 0:a.taskId)===m){if(e)return;e=!0,r=((p=(w=c.data)==null?void 0:w.data)==null?void 0:p.success)||!1,clearTimeout(o),window.removeEventListener("message",g),t(r)}};window.addEventListener("message",g)}),Ee=t=>new Promise(r=>{let e=!1,s=!1,o=3*1e3,m=setTimeout(()=>{s||(s=!0,window.removeEventListener("message",c),r(e))},o),g=N();window.postMessage({event:k,type:"upload",data:{taskId:g,files:t}});let c=u=>{var h,d,a,w,p,i;if(((h=u.data)==null?void 0:h.event)===k&&((d=u.data)==null?void 0:d.type)==="upload_result"&&((w=(a=u.data)==null?void 0:a.data)==null?void 0:w.taskId)===g){if(s)return;e=((i=(p=u.data)==null?void 0:p.data)==null?void 0:i.success)||!1,s=!0,clearTimeout(m),window.removeEventListener("message",c),r(e)}};window.addEventListener("message",c)}),ce=t=>new Promise(r=>{let e=t[0],s=ve();if(!s||!(e!=null&&e.blobUrl)){r(!1);return}let o=new XMLHttpRequest;o.open("GET",e.blobUrl,!0),o.withCredentials=!0,o.responseType="blob",o.onload=function(){if(this.status===200){let m=this.response,g=new Blob([m],{type:e.fileType}),c=new File([g],e.fileName,{type:e.fileType}),u=new DataTransfer;u.items.add(c);let h=u.files;Ee(t).then(d=>{if(!d){r(!1);return}s.files=h;let a=new Event("change",{bubbles:!0});s.dispatchEvent(a),r(!0)})}else r(!1)},o.send()}),le=t=>{let r=e=>{var s,o,m,g,c;if(((s=e.data)==null?void 0:s.event)===k&&((o=e.data)==null?void 0:o.type)==="upload_change_result"&&((c=(g=(m=e.data)==null?void 0:m.data)==null?void 0:g.files)==null?void 0:c.length)){let u=e.data.data.files;t(u)}};return window.addEventListener("message",r),()=>{window.removeEventListener("message",r)}};var q=String("MaxAI.me"),ye=()=>{setInterval(()=>{document.title=`${q} - AI Copilot for the Web`},1e3)},f=new Y("ChatGPTDaemonProcessPage"),pe=()=>window.localStorage.getItem("hide_usechatgptai_daemon_process_button")==="false",Te=()=>{let t=(0,n.useRef)(new R),[r,e]=(0,n.useState)(!1),[s,o]=(0,n.useState)(!1),m=(0,n.useRef)(!1);ae();let g=()=>{var a,w,p;let c=document.body.querySelectorAll("h1");for(let i=0;i<c.length;i++){let x=((a=c[i])==null?void 0:a.innerText)||"";if(x.indexOf("ChatGPT")>-1||x.indexOf("New chat")>-1){o(!0);return}}let u=document.body.querySelectorAll("textarea");for(let i=0;i<u.length;i++)if(u[i]instanceof HTMLTextAreaElement){o(!0);return}let h=document.querySelectorAll("nav a");for(let i=0;i<h.length;i++)if(((w=h[i])==null?void 0:w.innerText)==="Log out"){o(!0);return}let d=document.querySelectorAll("a");for(let i=0;i<d.length;i++)if(((p=d[i])==null?void 0:p.innerText)==="New chat"){o(!0);return}o(!1)};return(0,n.useEffect)(()=>{let c=setInterval(()=>{if(m.current){clearInterval(c);return}g()},1e3);return()=>{clearInterval(c)}},[]),(0,n.useEffect)(()=>{if(s){m.current=!0;let c=new M({runtime:"client"}),u=new M({runtime:"daemon_process"});u.postMessage({event:"OpenAIDaemonProcess_daemonProcessExist",data:{}}).then(async a=>{var w,p;if(f.info(a),a.success&&((w=a.data)==null?void 0:w.isExist)===!1){f.info(`init ${q} chatGPT daemon process`);try{await c.postMessage({event:"Client_updateTabVisible",data:{visible:!1,windowVisible:!1,windowFocus:!1}});let[i=[],x=[]]=await Promise.all([t.current.getAllModels(),t.current.getAllPlugins()]);if(i.length>0){await Z(D=>{let C=D.currentModel,P=i.find(v=>{var l;return(l=v==null?void 0:v.title)==null?void 0:l.includes("Default")})||i[0];return C&&i.find(l=>(l==null?void 0:l.slug)===C)||(C=P==null?void 0:P.slug),f.info("set currentModel model",C),{...D,models:i,currentModel:C,plugins:x}}),await u.postMessage({event:"OpenAIDaemonProcess_setDaemonProcess"}),ye();let I=document.getElementById("__next");I&&!pe()&&(I==null||I.classList.add("use-chat-gpt-ai-running")),e(!0),G.default.runtime.onMessage.addListener(d)}}catch(i){await c.postMessage({event:"Client_updateTabVisible",data:{visible:!0,windowVisible:!0,windowFocus:!0}}),f.error(i),setTimeout(()=>{window.location.reload()},1e3)}}else f.info("close listen"),(p=document.getElementById(X))==null||p.remove()});let h=le(a=>{c.postMessage({event:"Client_chatUploadFilesChange",data:{files:a}})}),d=async a=>{let{event:w,data:p}=a;if(!((a==null?void 0:a.id)&&a.id!==Q))return new Promise(i=>{(async()=>{var I,D,C,P,v;switch(w){case"OpenAIDaemonProcess_ping":return f.info("DaemonProcess_ping"),await u.postMessage({event:"OpenAIDaemonProcess_pong"}),{success:!0,data:{},message:"ok"};case"OpenAIDaemonProcess_createConversation":{let{conversationId:l,model:E}=p;f.info("DaemonProcess_createConversation",l,E);let A=await((I=t.current)==null?void 0:I.createConversation(l,E));return A?{success:!0,data:{conversationId:(A==null?void 0:A.conversationId)||""},message:"create conversation success"}:{success:!1,data:{conversationId:""},message:"create conversation fail"}}break;case"OpenAIDaemonProcess_askChatGPTQuestion":{let{taskId:l,question:E,options:A}=p;f.info("OpenAIDaemonProcess_askChatGPTQuestion",l,E,A);let{conversationId:W,messageId:y,parentMessageId:fe,question:ge}=E,_=(D=t.current)==null?void 0:D.getConversation(W);if(_||(_=await((C=t.current)==null?void 0:C.createConversation(W)),_&&await _.fetchHistoryAndConfig()),_){let V=new AbortController,he=()=>{f.info("AbortFunction exec",y),V.abort()};(P=t.current)==null||P.addAbortWithMessageId(y,he),await _.generateAnswer({meta:A.meta,messageId:y,parentMessageId:fe,prompt:ge,signal:V.signal,onEvent(T){var $,J;if(T.type==="error"){f.info("error"),f.info("abort Controller remove",y),($=t.current)==null||$.removeAbortWithMessageId(y),u.postMessage({event:"OpenAIDaemonProcess_taskResponse",data:{taskId:l,data:T.data,error:T.data.message||T.data.detail||"",done:!0}});return}if(T.type==="done"){f.info("done"),f.info("abort Controller remove",y),(J=t.current)==null||J.removeAbortWithMessageId(y),u.postMessage({event:"OpenAIDaemonProcess_taskResponse",data:{taskId:l,data:{},error:"",done:!0}});return}u.postMessage({event:"OpenAIDaemonProcess_taskResponse",data:{taskId:l,data:T.data,error:"",done:!1}}),f.info(T.data)}},A.regenerate===!0)}}break;case"OpenAIDaemonProcess_removeConversation":{let{conversationId:l}=p;if(f.info("OpenAIDaemonProcess_removeConversation",l),l)return{success:await t.current.closeConversation(l),data:{},message:"ok"}}break;case"OpenAIDaemonProcess_abortAskChatGPTQuestion":{let{messageId:l}=p;return f.info("OpenAIDaemonProcess_abortAskChatGPTQuestion listen",l),l?((v=t.current)==null||v.abortWithMessageId(l),{success:!0,data:{},message:"ok"}):{success:!1,data:{},message:"messageId is empty"}}break;case"OpenAIDaemonProcess_pingFilesUpload":return{success:await ie(),data:{},message:"ok"};case"OpenAIDaemonProcess_filesUpload":{let{files:l}=p;return{success:await ce(l),data:{},message:"ok"}}break;default:break}})().then(I=>{I&&I.data&&i(I)})})};return()=>{h(),G.default.runtime.onMessage.removeListener(d)}}return()=>{}},[s]),{showDaemonProcessBar:r}},_e=()=>{let{showDaemonProcessBar:t}=Te(),[r,e]=(0,n.useState)(()=>pe());return t?r?n.default.createElement(n.default.Fragment,null,n.default.createElement(ue,null)):n.default.createElement(n.default.Fragment,null,n.default.createElement(L,{sx:{top:0,position:"absolute",height:40,width:"100%",bgcolor:String("USE_CHAT_GPT_AI")==="EZ_MAIL_AI"?"#1D56D7":"#7601D3",zIndex:String("USE_CHAT_GPT_AI")==="EZ_MAIL_AI"?999:1e3,color:"#fff"},spacing:1,direction:"row",alignItems:"center",justifyContent:"center"},n.default.createElement("div",{className:"use-chat-gpt-ai-setting-icon"},n.default.createElement(de.default,{sx:{fontSize:16}})),n.default.createElement(F,{variant:"body1",component:"span"},`Please keep this page open to use ${q} extension.`),n.default.createElement(oe,{sx:{position:"absolute",right:16,color:"#fff"},onClick:()=>{if(window.confirm("Once you click 'OK', the ChatGPT.AI top bar won't show up anymore. But please still keep this ChatGPT tab open so you can keep using the MaxAI.me extension without interruption.")){window.localStorage.setItem("hide_usechatgptai_daemon_process_button",JSON.stringify(!1));let o=document.getElementById("__next");o&&o.classList.remove("use-chat-gpt-ai-running"),e(!0)}}},n.default.createElement(me.default,null))),n.default.createElement(ue,null)):null},U=t=>{let r=document.getElementById(O);if(r)r.src=t;else{let e=document.createElement("iframe");e.id=O,e.style.cssText="height: 0px; width: 100%;",e.src=t,e.onload=function(){let o=e.contentWindow&&e.contentWindow.document.documentElement.innerText||"{}";try{JSON.parse(o).expires||o.match(/Please stand by|while we are checking your browser|Please turn JavaScript on|Please enable Cookies|reload the page/)}catch(m){}};let s=document.querySelector("main");s&&s.lastElementChild&&s.lastElementChild.appendChild(e)}},Se=(t="/api/auth/session")=>new Promise(r=>{fetch(t).then(e=>{e.text().then(s=>{try{let o=e.headers.get("Content-Type");if(o&&o.indexOf("application/json")>-1&&e.status!==403&&s.indexOf('"expires":"')>-1){let m=document.getElementById(O);m&&m.contentWindow?m.contentWindow.document.documentElement.innerHTML=s:U(t),r(!0)}else U(t),r(!1)}catch(o){U(t),r(!1)}})})}),ue=()=>{let t=(0,n.useRef)(!1),[r,e]=(0,n.useState)(!1),[s,o]=(0,n.useState)("");return K(()=>{(async()=>{try{let c=(await G.default.storage.local.get(B)||{})[B];if(c){let{end:u}=JSON.parse(c),h=(0,H.default)().utc(),d=(0,H.default)(u).utc().diff(h,"seconds"),a="";if(d<60?a="1 minute":d<3600?a=`${Math.floor(d/60)} minutes`:d<86400&&(d<7200?a="1 hour":a=`${Math.floor(d/60/60)} hours`),o(a),d>30){t.current=!0,e(!0);return}}e(!1),t.current=!1}catch(g){t.current=!1}})()},1e3*3),K(()=>{t.current&&Se()},1e3*30),n.default.createElement(n.default.Fragment,null,r&&n.default.createElement(ee,{position:"absolute",right:8,top:8,zIndex:1e4},n.default.createElement(re,{icon:n.default.createElement(n.default.Fragment,null),sx:{p:"16px!important",bgcolor:"#fff",border:"1px solid #7601D3","& > div":{"&:first-of-type":{display:"none"},"&:nth-of-type(2)":{padding:"0!important"},"&:last-of-type":{margin:"0!important",padding:"0!important",position:"absolute",top:4,right:4}},"& *":{color:"#7601D3"}}},n.default.createElement(L,{spacing:1},n.default.createElement(L,{direction:"row",alignItems:"center",spacing:1},n.default.createElement(ne,{sx:{fontSize:16}}),n.default.createElement(F,{variant:"body1",fontSize:16,fontWeight:700},"Stable Mode is enabled")),n.default.createElement(F,{variant:"body1",fontSize:16},"Will be disabled automatically in ",s),n.default.createElement(te,{disableElevation:!0,variant:"contained",sx:{bgcolor:"#7601D3",color:"#fff","&:hover":{bgcolor:"#7601D3"},textTransform:"none"},onClick:async()=>{await se({key:"options",query:"#chatgpt-stable-mode"})}},"Disable now")))))},Ye=_e;export{Ye as default};
